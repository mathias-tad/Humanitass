# Docker Compose - Humanitas ERP Platform
# This configuration orchestrates all 8 microservices

version: '3.8'

services:
  # =========================================================================
  # Service 1: Admin API (Tenant Management)
  # =========================================================================
  admin-api:
    build: ./backend/admin-api
    container_name: humanitas-admin-api
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_SSL=${DATABASE_SSL:-false}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=7d
      - API_PREFIX=api/v1
      - FRONTEND_URL=${ADMIN_FRONTEND_URL:-http://localhost:5173}
      - CORS_ORIGINS=${CORS_ORIGINS}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - humanitas-network

  # =========================================================================
  # Service 2: Tenant API (Business  Logic)
  # =========================================================================
  tenant-api:
    build: ./backend/tenant-api
    container_name: humanitas-tenant-api
    restart: always
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - ENABLE_CRON=false # No cron jobs on API server
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_SSL=${DATABASE_SSL:-false}
      - ADMIN_BACKEND_URL=http://admin-api:3000/api/v1
      - CALCULATION_SERVICE_URL=http://python-api:8000
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=8h
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:1300}
      - CORS_ORIGINS=${CORS_ORIGINS}
    depends_on:
      - admin-api
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - humanitas-network

  # =========================================================================
  # Service 3: Tenant Worker (Background Jobs & Cron)
  # =========================================================================
  tenant-worker:
    build: ./backend/tenant-api
    container_name: humanitas-tenant-worker
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3002
      - ENABLE_CRON=true # Enable cron jobs
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_SSL=${DATABASE_SSL:-false}
      - ADMIN_BACKEND_URL=http://admin-api:3000/api/v1
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - admin-api
      - tenant-api
    networks:
      - humanitas-network

  # =========================================================================
  # Service 4: Python Calculation API (FastAPI)
  # =========================================================================
  python-api:
    build: ./backend/calculation-service
    container_name: humanitas-python-api
    restart: always
    ports:
      - "8000:8000"
    environment:
      - ADMIN_DATABASE_URL=${DATABASE_URL}
      - DEBUG=false
    command: python run.py
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - humanitas-network

  # =========================================================================
  # Service 5: Python Worker (Background Calculations)
  # =========================================================================
  python-worker:
    build: ./backend/calculation-service
    container_name: humanitas-python-worker
    restart: always
    environment:
      - ADMIN_DATABASE_URL=${DATABASE_URL}
      - DEBUG=false
    depends_on:
      - python-api
    command: python -m app.worker_main
    networks:
      - humanitas-network

  # =========================================================================
  # Service 6: Admin Frontend (React)
  # =========================================================================
  admin-frontend:
    build:
      context: ./frontend/admin-dashboard
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${ADMIN_API_URL:-http://localhost:3000/api/v1}
    container_name: humanitas-admin-frontend
    restart: always
    ports:
      - "5173:80"
    depends_on:
      - admin-api
    networks:
      - humanitas-network

  # =========================================================================
  # Service 7: Tenant Frontend (React)
  # =========================================================================
  tenant-frontend:
    build:
      context: ./frontend/tenant-dashboard
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${TENANT_API_URL:-http://localhost:3001/api/v1}
        VITE_SOCKET_URL: ${SOCKET_URL:-http://localhost:3001}
    container_name: humanitas-tenant-frontend
    restart: always
    ports:
      - "1300:80"
    depends_on:
      - tenant-api
    networks:
      - humanitas-network

  # =========================================================================
  # Service 8: Nginx (Reverse Proxy & API Gateway)
  # =========================================================================
  nginx:
    image: nginx:alpine
    container_name: humanitas-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/ssl:/etc/nginx/ssl:ro # Optional: SSL certificates
    depends_on:
      - admin-api
      - tenant-api
      - admin-frontend
      - tenant-frontend
    networks:
      - humanitas-network

networks:
  humanitas-network:
    driver: bridge

# Optional: Add PostgreSQL for local development
# Uncomment if you want to run database locally instead of using cloud database
#
# volumes:
#   postgres_data:
#
# services:
#   postgres:
#     image: postgres:14-alpine
#     container_name: humanitas-postgres
#     restart: always
#     ports:
#       - "5432:5432"
#     environment:
#       - POSTGRES_USER=humanitas
#       - POSTGRES_PASSWORD=humanitas_password
#       - POSTGRES_DB=humanitas_db
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     networks:
#       - humanitas-network
